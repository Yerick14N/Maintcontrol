
{% extends "base.html" %}
{% block content %}
<h1>
  {% if intervention %}
    <span data-i18n="interventions_edit">Modifier une intervention</span>
  {% else %}
    <span data-i18n="interventions_new">Nouvelle intervention</span>
  {% endif %}
</h1>

<form method="post" class="form">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <label>
    <span data-i18n="col_title">Titre</span>
    <input type="text" name="title" required value="{{ intervention.title if intervention else '' }}">
  </label>  <label>
    <span data-i18n="customer_select">Client (base clients)</span>
    {% set cid = intervention.customer_id if intervention else '' %}
    <select name="customer_id">
      <option value=""></option>
      {% for c in customers %}
      <option value="{{ c.id }}" {% if cid==c.id %}selected{% endif %}>{{ c.name }}</option>
      {% endfor %}
    </select>
  </label>

  <label>
    <span data-i18n="col_client">Client chantier (texte)</span>
    <input type="text" name="client_name" value="{{ intervention.client_name if intervention else '' }}">
  </label>

  <div class="grid-two">
    <label>
      <span>Équipement (optionnel)</span>
      {% set eid = intervention.equipment_id if intervention else '' %}
      <select name="equipment_id">
        <option value=""></option>
        {% for e in equipments %}
          <option value="{{ e.id }}" {% if eid==e.id %}selected{% endif %}>{{ e.name }}</option>
        {% endfor %}
      </select>
    </label>
    <label>
      <span>Contrat (optionnel)</span>
      {% set coid = intervention.contract_id if intervention else '' %}
      <select name="contract_id">
        <option value=""></option>
        {% for c in contracts %}
          <option value="{{ c.id }}" {% if coid==c.id %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
    </label>
  </div>

  <label>
  <div style="display:flex; justify-content:space-between; align-items:center; gap:0.5rem;">
    <strong>Salariés affectés</strong>
    <button class="btn btn-small" type="button" data-assign-me="{{ current_user.id }}">M’assigner</button>
  </div>
  <select id="assignees" name="assignees" multiple size="6">
    {% for e in employees %}
      <option value="{{ e.id }}" {% if e.id in selected_assignees %}selected{% endif %}>{{ e.username }}{% if e.role %} ({{ e.role }}){% endif %}</option>
    {% endfor %}
  </select>
  <small>Astuce : Ctrl/Cmd pour sélectionner plusieurs.</small>
</label>


  <details>
    <summary class="help">Champs avancés (statut, priorité, description…)</summary>
    <div style="margin-top:0.75rem;">
      <label>
        <span data-i18n="col_description">Description</span>
        <textarea name="description">{{ intervention.description if intervention else '' }}</textarea>
      </label>

  <label>
    <span data-i18n="col_status">Statut</span>
    {% set st = intervention.status if intervention else 'open' %}
    <select name="status">
      <option value="open" {% if st=='open' %}selected{% endif %}>Ouvert</option>
      <option value="in_progress" {% if st=='in_progress' %}selected{% endif %}>En cours</option>
      <option value="done" {% if st=='done' %}selected{% endif %}>Clôturé</option>
    </select>
  </label>

  <label>
    <span data-i18n="col_priority">Priorité</span>
    {% set pr = intervention.priority if intervention else 'medium' %}
    <select name="priority">
      <option value="critical" {% if intervention and intervention.priority=="critical" %}selected{% endif %} data-i18n="prio_critical">Critical</option>
      <option value="high" {% if intervention and intervention.priority=="high" %}selected{% endif %} data-i18n="prio_high">Haute</option>
      <option value="medium" {% if intervention and intervention.priority=="medium" %}selected{% endif %} data-i18n="prio_medium">Moyenne</option>
      <option value="low" {% if intervention and intervention.priority=="low" %}selected{% endif %} data-i18n="prio_low">Basse</option>
    </select>
  </label>

  <label>
    <span data-i18n="col_kind">Type</span>
    {% set kd = intervention.kind if intervention else '' %}
    <select name="kind">
      <option value="" {% if not kd %}selected{% endif %}></option>
      <option value="corrective" {% if kd=='corrective' %}selected{% endif %}>Correctif</option>
      <option value="preventive" {% if kd=='preventive' %}selected{% endif %}>Préventif</option>
      <option value="installation" {% if kd=='installation' %}selected{% endif %}>Installation</option>
    </select>
  </label>

  <label>
    <span data-i18n="col_category">Catégorie</span>
    {% set ct = intervention.category if intervention else '' %}
    <select name="category">
      <option value="" {% if not ct %}selected{% endif %}></option>
      <option value="electricity" {% if ct=='electricity' %}selected{% endif %}>Électricité</option>
      <option value="plumbing" {% if ct=='plumbing' %}selected{% endif %}>Plomberie</option>
      <option value="hvac" {% if ct=='hvac' %}selected{% endif %}>HVAC</option>
      <option value="it" {% if ct=='it' %}selected{% endif %}>IT</option>
    </select>
  </label>

    </div>
  </details>

  <label>
    <span data-i18n="col_scheduled">Date planifiée</span>
    <input type="date" name="scheduled_date" value="{{ (intervention.scheduled_date[:10] if intervention and intervention.scheduled_date else '') }}">
  </label>

  <div class="form-actions">
    <button type="submit" name="action" value="save" class="btn primary" data-i18n="save">Enregistrer</button>
    {% if intervention %}
    <button type="submit" name="action" value="delete" class="btn danger" data-i18n="delete" onclick="return confirm('Confirmer la suppression ?');">Supprimer</button>
    {% endif %}
  </div>
</form>
{% endblock %}
